<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Getting Loaded :: Pulse Code ‚Äî Ben Coleman</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Load Testing. Not the coolest of subjects these days, you could argue, but one close to my heart. Back in 2004 I joined a software company called Mercury, at the time well know for a load testing product called LoadRunner.
For a while my career was very focused on measuring &amp;amp; reporting application performance in various ways. Fifteen years later and the whole industry has changed and evolved, load testing has slipped from the limelight; however people still obviously care about the performance of their web apps, so it has never gone away."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/blog/getting-loaded/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Getting Loaded"/>
<meta name="twitter:description" content="Load Testing. Not the coolest of subjects these days, you could argue, but one close to my heart. Back in 2004 I joined a software company called Mercury, at the time well know for a load testing product called *LoadRunner*."/>



<meta property="og:title" content="Getting Loaded" />
<meta property="og:description" content="Load Testing. Not the coolest of subjects these days, you could argue, but one close to my heart. Back in 2004 I joined a software company called Mercury, at the time well know for a load testing product called *LoadRunner*." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/getting-loaded/" />
<meta property="article:published_time" content="2019-09-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-07T00:00:00+00:00" /><meta property="og:site_name" content="Pulse Code" />



<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.12.0/css/light.css" integrity="sha384-i+ivMdAc0+wLEnd+UdXLpYGNTbyn/0Rjz7EqmkqEOkfat5/2T+S63wn3WDk6h4Yh" crossorigin="anonymous">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.12.0/css/fontawesome.css" integrity="sha384-CtsKDnRWWHDhjRZ5qgpCFCGpib2FU2SChFu0xRt81grgvXq1P+lbpROQoBLxlU4o" crossorigin="anonymous">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.12.0/css/solid.css" integrity="sha384-U9f9KTMQ1TBvUUFLpp6FgAy1M59lrF3q3rYTHPRVtT8OzY3xyyFUzKevJFYHEbhq" crossorigin="anonymous">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.12.0/css/brands.css" integrity="sha384-z3CBOpMFSI4D+GXPvBsSW5vXhm4MEzWuC/CycHv+vsuzuztOzPpomZimFLeWNOgk" crossorigin="anonymous">

<link rel="icon" type="image/png" href="/favicon.png">

  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">pulse code</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/blog">Blog</a></li>
        
      
        
          <li><a href="/projects">Projects</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">
            Show more
            <span class="menu__sub-inner-more-trigger-icon"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
          </li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/tags">Blog Tags</a></li>
              
            
              
                <li><a href="/personal">Personal</a></li>
              
            
          </ul>
        </ul>
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/blog">Blog</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/tags">Blog Tags</a></li>
      
    
      
        <li><a href="/personal">Personal</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/blog/getting-loaded/">Getting Loaded</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-09-07
        </span>
      
      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/azure/">azure</a>&nbsp;
        
          #<a href="/tags/load-testing/">load-testing</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <p>Load Testing. Not the coolest of subjects these days, you could argue, but one close to my heart. Back in 2004 I joined a software company called Mercury, at the time well know for a load testing product called <em>LoadRunner</em>.</p>
<p>For a while my career was very focused on measuring &amp; reporting application performance in various ways. Fifteen years later and the whole industry has changed and evolved, load testing has slipped from the limelight; however people still obviously care about the performance of their web apps, so it has never gone away.</p>
<p>In this post I'll be exploring using a lightweight, modern load testing tool called <em>k6</em> and combining it with Azure to provide a reporting solution</p>
<h1 id="overview">Overview</h1>
<p>There's three main areas I'll be covering, these logically flow together but feel free to jump ahead:</p>
<ul>
<li><a href="#introduction-to-k6">Using k6, running tests and generating data. You can read this part if you're just interesting in taking k6 for a spin</a></li>
<li><a href="#integration-with-azure-monitor">Pushing results to Azure. This is more focused on Azure Log Analytics and it's APIs</a></li>
<li><a href="#visualizing-the-data">Building reports and viewing the data. Here I'll look at Kusto queries &amp; Azure Monitor workbooks</a></li>
</ul>
<p>I will just add at this point, what I'm covering does skip over some aspects of load testing, namely; the injection of load from multiple load generation locations/agents and interpreting the results (an art in itself). Also this hasn't been battle tested in production or with longer/larger tests</p>
<h1 id="introduction-to-k6">Introduction to k6</h1>
<p>I discovered k6 (<a href="https://k6.io/">k6.io</a>) a little while back, while investigating ways to artificially stress an application for a demo. K6 is an open source tool for load testing; it's lightweight, &ldquo;developer centric&rdquo; and effectively lets you create your loads tests as you would unit tests; in code form. This is important in the new world of &ldquo;everything as code&rdquo; and for CI/CD. It really fired up my imagination on what I could use it for on my own projects, and running it in Azure, which has lead eventually to this post</p>
<p>I won't go too much into all the features using k6, <a href="https://docs.k6.io/docs/welcome">their docs can do a better job than I ever could</a>{:target=&rdquo;_blank&rdquo;}. Suffice to say, your load test is a simple JavaScript file with one exported function which is called when running the test. A test file can be very simple, for example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">http</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;k6/http&#34;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">function</span>() {
  <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;http://example.com&#34;</span>);
};
</code></pre></div><p>I hope that's pretty self explanatory what is going on, if not this might not be the post for you! ;)</p>
<p>Let's expand this to a more real world scenario, testing against a REST API, which I imagine many people reading this will be looking to do. In this case some simple requests against <a href="https://docs.postman-echo.com">Postman's nice API echo service</a>{:target=&rdquo;_blank&rdquo;}</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">http</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;k6/http&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">check</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;k6&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">group</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;k6&#34;</span>;

<span style="color:#75715e">// Can override the API endpoint byt setting API_HOST env var
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">API_HOST</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">__ENV</span>.<span style="color:#a6e22e">API_HOST</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">https://postman-echo.com</span><span style="color:#e6db74">`</span>

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">function</span>() {
  <span style="color:#75715e">// Group for API GET requests
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">group</span>(<span style="color:#e6db74">&#34;API GET Existing cheese&#34;</span>, <span style="color:#66d9ef">function</span>() {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">API_HOST</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/get?cheese=cheddar</span><span style="color:#e6db74">`</span>;

    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">url</span>);

    <span style="color:#75715e">// Validate result with a check function
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">check</span>(<span style="color:#a6e22e">res</span>, {
      <span style="color:#e6db74">&#34;Status was 200&#34;</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">r</span>) =&gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">200</span>,
      <span style="color:#e6db74">&#34;Returned cheese has correct name&#34;</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">r</span>) =&gt; <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">body</span>).<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">cheese</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;cheddar&#34;</span>
    });
  });

  <span style="color:#75715e">// Group for API POST requests
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">group</span>(<span style="color:#e6db74">&#34;API POST New cheese&#34;</span>, <span style="color:#66d9ef">function</span>() {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">API_HOST</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/post</span><span style="color:#e6db74">`</span>;
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
      <span style="color:#e6db74">&#34;cheese&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;edam&#34;</span>,
    });

    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">post</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">payload</span>, { <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#34;Content-Type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span> } });

    <span style="color:#75715e">// Validate result with a check function
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">check</span>(<span style="color:#a6e22e">res</span>, {
      <span style="color:#e6db74">&#34;Status was 200&#34;</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">r</span>) =&gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">200</span>,
      <span style="color:#e6db74">&#34;Response has data object&#34;</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">r</span>) =&gt; <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">body</span>).<span style="color:#a6e22e">data</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;object&#34;</span>
    });
  });
};
</code></pre></div><p>Whoa! That's quite a jump, but again I think it's pretty easy to read and see what's going on. I've introduced a few things here:</p>
<ul>
<li>Groups to logically combine &amp; name requests. I use these named groups in the reports, as well see later</li>
<li>Checks to validate the responses. Anyone that's written unit tests for an API will be pretty familiar what is going on here, I'm simply checking what comes back (status codes, body), is what we expect based on the API we're calling. We could easily cross the line here into another level of testing, so I would advise to keep the checks to a minimum and leave the task of finding every edge case to your unit/integration tests.<br>
Note. I could probably use an assertion library like <a href="https://www.chaijs.com/">Chai</a>{:target=&rdquo;_blank&rdquo;} but I wanted to keep external dependencies out of this for now</li>
<li>One of the calls is a POST with a data payload, in JSON form</li>
<li>I've parameterized the API hostname. Why? well in this case the URL is fixed to <code>postman-echo.com</code>, but assuming in a real project you'll be running your tests under a CD pipeline. In those situations, the API endpoint is likely to be dynamically created prior to the test via some cloud resource, containers, Kubernetes etc.</li>
</ul>
<h2 id="running-load-tests-in-continuous-deployment">Running Load Tests in Continuous Deployment</h2>
<p>Running your tests is easy as calling <code>k6 run</code>, as it's a CLI tool, written in Go, <a href="https://docs.k6.io/docs/installation">you can grab the binary</a> and you are all set. For example running <code>k6 run mytest.js</code> will fire off your test script and show some nice stats after the run</p>
<p>One thing you'll want to do is set the number of virtual users (VUs) and ramp them up or down across several timed &ldquo;stages&rdquo; in your test. This determines both the length of test and how much you want to hammer the target system.</p>
<p>Again this is something you specify in code, in your JavaScript test file. You just place an exported <code>options</code> object at the top of your script (<a href="https://docs.k6.io/docs/options">full docs here</a>{:target=&rdquo;_blank&rdquo;})</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { 
  <span style="color:#a6e22e">maxRedirects</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>,
  <span style="color:#a6e22e">stages</span><span style="color:#f92672">:</span> [
    { <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;10s&#39;</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> }, <span style="color:#75715e">// 10 seconds of 10 VUs
</span><span style="color:#75715e"></span>    { <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;20s&#39;</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">20</span> }, <span style="color:#75715e">// 20 seconds of 20 VUs
</span><span style="color:#75715e"></span>    { <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;45s&#39;</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span> }, <span style="color:#75715e">// 45 seconds of 50 VUs
</span><span style="color:#75715e"></span>    { <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;3m&#39;</span>,  <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">80</span> }, <span style="color:#75715e">// 3 minutes of 80 VUs
</span><span style="color:#75715e"></span>    { <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;10s&#39;</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> },  <span style="color:#75715e">// 10 ramping down to zero VUs
</span><span style="color:#75715e"></span>  ],
  <span style="color:#a6e22e">thresholds</span><span style="color:#f92672">:</span> {
    <span style="color:#e6db74">&#34;failed requests&#34;</span><span style="color:#f92672">:</span>   [ <span style="color:#e6db74">&#34;rate &lt; 0.1&#34;</span> ],  <span style="color:#75715e">// Check total failed requests
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">&#34;http_req_duration&#34;</span><span style="color:#f92672">:</span> [ <span style="color:#e6db74">&#34;avg &lt; 500&#34;</span> ]    <span style="color:#75715e">// Check average response times under 500ms
</span><span style="color:#75715e"></span>  }
};
</code></pre></div><p>The thresholds section is optional but can be used to mark the run as &ldquo;failed&rdquo; when certain metrics fall outside specific parameters.</p>
<p>When it comes to running from a Continuous Deployment (CD) pipeline, chances are your build-runner/agent won't have k6 installed, but you can work around that. I use Azure YAML Pipelines (and the Microsoft hosted agents),  so here's an example step with a snippet of bash to include in your pipeline, that gets k6 binary and runs your test</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- displayName: Run a load test with k6
  bash: <span style="color:#e6db74">|
</span><span style="color:#e6db74">   </span><span style="color:#e6db74"> </span><span style="color:#e6db74">wget -q https://github.com/loadimpact/k6/releases/download/v0.25.1/k6-v0.25.1-linux64.tar.gz</span>
    tar -xzf k6-v0<span style="color:#ae81ff">.25</span><span style="color:#ae81ff">.1</span>-linux64.tar.gz
    ./k6-v0<span style="color:#ae81ff">.25</span><span style="color:#ae81ff">.1</span>-linux64/k6 run -q -e API_HOST=http://$(apiHost) loadtest.js --out json=result.json
  workingDirectory: path/toYour/loadtests
</code></pre></div><p>Some comments:</p>
<ul>
<li>Yes we're running the test from the build agent, lengthy tests with high number of VUs is going to tie up the build machine. A better approach would be to trigger the run on some remote &ldquo;load injector&rdquo; (as we called them in the LoadRunner days), one idea I had was to use Azure Container Instances. The complexity of passing data to/from the remote system caused me to skip this idea for the short term and keep it simple.</li>
<li><code>-q</code> enables quiet mode, this disables the progress bar, but you still get the nice stats printed at the end.</li>
<li>The <code>-e API_HOST=http://$(apiHost)</code> argument passes the Azure Devops variable <code>apiHost</code> into the script as an environmental variable API_HOST</li>
<li><code>--out json=results.json</code> writes all the metrics and data for the run out at a JSON file. Which is what we'll use in the next step</li>
</ul>
<h1 id="integration-with-azure-monitor">Integration with Azure Monitor</h1>
<p>Next task is to get the <code>results.json</code> somewhere where we can do something useful with it, visualize and report on what happened in the test run. The raw file is likely to be HUGE, and running reports directly off it via Excel or PowerBI is extremely problematic due to the density of the data points (down to the microsecond). What we need is some sort of time series database.</p>
<p>Azure Monitor Log Analytics (or just Log Analytics) is something typically used in Azure to record &ldquo;system level data&rdquo; i.e. monitoring data from a range of sources, logs, application events, machine metrics etc. It might not be your first choice for the problem in hand but it has a few characteristics which make it well suited:</p>
<ul>
<li>It is time series based</li>
<li>It can cope with large datasets (far, far larger than our result.json)</li>
<li>It has a powerful query system, Kusto</li>
<li>It has an API for loading any type of data you wish</li>
<li>It's available as a service</li>
<li>Via Azure Monitor you can visualize the data with queries in various chart formats, directly in the Azure Portal</li>
</ul>
<p>To get the data in to Log Analytics, I used the <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-collector-api"><em>HTTP Data Collector API</em></a>{:target=&rdquo;_blank&rdquo;}. This is a REST interface to push any data you wish into Log Analytics. I wrote a Node.js script to take a JSON file output from a k6 run and load it via this API</p>
<p>Some notes on developing this script:</p>
<ul>
<li>Authentication on the <em>HTTP Data Collector API</em> is based on a HMAC-SHA256 signed signature, generating this signature requires some very specific code, and the API is <em><strong>extremely</strong></em> fussy. This took a lot of time to get right, even with the code samples provided in the docs.</li>
<li>The API accepts 30mb worth of payload in a single request, I had to find a way to batch and chunk the JSON file into multiple requests.</li>
<li>You are able to inform Log Analytics if your data contains a timestamp, and it will use that in place of it's standard <code>TimeGenerated</code> field that all entries have. This was very useful as the k6 data had the timestamps I needed and the microsecond level timing data was critical</li>
</ul>
<p>Here is the <strong><a href="https://github.com/benc-uk/smilr/blob/master/azure/load-test-reports/k6ToAzure.js">resulting script: k6ToAzure.js</a></strong></p>
<p>It is standalone (no external NPM modules used), just Node.js v10+ required. It takes four arguments: the JSON filename, a name for the run to tag the data with, the id of the target Log Analytics workspace, the shared key of the Log Analytics workspace</p>
<p>Getting your Log Analytics workspace id is pretty easy, it's in the portal, and obtainable via the Azure CLI with:</p>
<pre><code>az resource show -n $workspaceName -g $resGroup --resource-type Microsoft.OperationalInsights/workspaces --query &quot;properties.customerId&quot; -o tsv`
</code></pre><p>The &ldquo;shared key&rdquo; is harder to come by, it's not easily found in the portal, but this Azure CLI REST call fetches it for us:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">az rest --method POST --uri https://management.azure.com/subscriptions/$subId/resourcegroups/$resGroup/providers/Microsoft.OperationalInsights/workspaces/$workspaceName/sharedKeys<span style="color:#ae81ff">\?</span>api-version<span style="color:#ae81ff">\=</span>2015-11-01-preview --query <span style="color:#e6db74">&#34;primarySharedKey&#34;</span> -o tsv
</code></pre></div><p>Adding the upload to your Azure Devops CD pipeline is just a matter of adding it to the bash task you already have. Assuming you've put <code>k6ToAzure.js</code> in the same directory as your loadtest JS file, and you've set <code>workspaceId</code> &amp; <code>workspaceKey</code> as pipeline variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">node k6ToAzure.js result.json <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Load Test for </span><span style="color:#66d9ef">$(</span>Build.BuildNumber<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">$(</span>workspaceId<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>workspaceKey<span style="color:#66d9ef">)</span>
</code></pre></div><h1 id="visualizing-the-data">Visualizing the Data</h1>
<p>Finally the interesting part! Taking a look at the data with some pretty charts.</p>
<p>This is done using <a href="https://docs.microsoft.com/en-us/azure/kusto/query/index">Kusto queries</a>{:target=&rdquo;_blank&rdquo;}, Kusto is the query language used by Log Analytics and other Azure services (App Insights, Azure Data Explorer). Kusto has a pretty steep learning curve and is crazy powerful, so there's no way I'm going into any depth here. However to get started you can go to your Log Analytics workspace in the portal and go into the &lsquo;Logs&rsquo; view</p>
<p>From here you'll see the data under &ldquo;Custom Logs&rdquo; in a table called <strong>LoadTesting_CL</strong>, you can start exploring the data with the query editor.</p>
<p><strong>Note. There is a first time delay of about 15 mins before data will appear, subsequent uploads of new data will have a delay of about 2-5 minutes</strong></p>
<p>Here is a example query which will display the <code>http_req_duration</code> (total time for each request in the load test) plotted over time. Data points are aggregated into 2 second chunks.<br>
You will need to change <code>&lt;&lt;given_run_name&gt;&gt;</code> to whatever you called/tagged the run when k6ToAzure.js uploaded it (i.e. the second argument)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">LoadTesting_CL
<span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> runName_s <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;&lt;given_run_name&gt;&gt;</span><span style="color:#e6db74">&#34;</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> metric_s <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">http_req_duration</span><span style="color:#e6db74">&#34;</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(data_value_d)
<span style="color:#f92672">|</span> project TimeGenerated, data_value_d, data_tags_group_s, data_tags_method_s
<span style="color:#f92672">|</span> summarize <span style="color:#66d9ef">avg</span>(data_value_d) <span style="color:#66d9ef">by</span> bin(TimeGenerated, <span style="color:#ae81ff">2000</span>ms), data_tags_group_s, data_tags_method_s 
<span style="color:#f92672">|</span> render timechart 
</code></pre></div><p>(P.S. If this Kusto query stuff all is too much, you can skip ahead to the Workbook section below)</p>
<p>With a bit of luck it should look something like this üòÅ</p>

  <figure class="left" >
    <img src="query-result.png"   />
    
      <figcaption class="center" >Query results in Log Analytics</figcaption>
    
  </figure>


<p>If you ever want a list of your run names you can use this query</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">LoadTesting_CL
<span style="color:#f92672">|</span> <span style="color:#66d9ef">distinct</span> runName_s
</code></pre></div><h2 id="using-workbooks">Using Workbooks</h2>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/usage-workbooks">Azure Monitor Workbooks</a>{:target=&rdquo;_blank&rdquo;} are a very new and sorely under publicized feature of Azure. They allow you to build your own interactive and dynamic set of views and reports in the Azure Portal, pulling in Log Analytics and other data. Using Workbooks we can build a friendly view allowing users to select the run name from a drop down list as well as other parameters</p>
<p>I've created a workbook you can import and use, so there's no need to worry about the details of the Kusto queries. Workbooks are exported &amp; shared in JSON format.</p>
<p>Link to <strong><a href="https://github.com/benc-uk/smilr/blob/master/azure/load-test-reports/workbook.json">workbook.json</a></strong></p>
<p>You can import this by going to Azure Monitor in the portal, creating a new workbook, then clicking the code icon on the far right of toolbar. Then simply paste the JSON in, replacing what is there</p>

  <img src="wb.png"  class="left"  />


<p>Once imported you can save and use the workbook. Pick your subscription, log workspace and run name from the drop downs, and the workbook does the rest (I hope!)</p>
<p>Below are some screenshot examples from my own data, <a href="https://imgur.com/3sRVecj">and this is a short video</a>{:target=&rdquo;_blank&rdquo;}</p>

  <figure class="left" >
    <img src="workbook-result-1.png"   />
    
      <figcaption class="center" >Response time and users</figcaption>
    
  </figure>



  <figure class="left" >
    <img src="workbook-result-2.png"   />
    
      <figcaption class="center" >Errors and breakdowns</figcaption>
    
  </figure>


<h1 id="summary">Summary</h1>
<p>This is been a long post (I always end up saying that!), but I've really enjoyed playing with k6 and experimenting with using the data. K6 is an fantastic tool for load testing, and can be easily added to any CD pipeline. Azure Log Analytics is a time series database in disguise, with a lot of features. Finally, Azure Monitor Workbooks are a little known feature of Azure allowing you to create useful interactive reports</p>
<p>Please get in touch if you try anything I've covered here üòÉ</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/blog/azure-search/">
                  <span class="button__text">Integrating with Azure Search</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">pulse code</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>¬© 2019 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
